<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PONNAR SENTINEL v6.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg: #020617; --neon: #22ffcc; --blue: #38bdf8; --red: #ff3b3b; --gold: #ffbf00; }
        body { margin: 0; background: var(--bg); font-family: 'Inter', sans-serif; color: #fff; overflow-x: hidden; }
        .shell { max-width: 800px; margin: auto; padding: 1rem; }
        .card { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(10px); border-radius: 20px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem; text-align: center; }
        .twod { font-size: 8rem; font-weight: 900; color: var(--neon); text-shadow: 0 0 30px rgba(34, 255, 204, 0.5); line-height: 1; }
        .label { font-size: 0.8rem; color: var(--blue); letter-spacing: 4px; margin-bottom: 10px; }
        .targets { display: flex; justify-content: center; gap: 1rem; margin-top: 20px; }
        .target { background: var(--gold); color: #000; padding: 0.5rem 1rem; border-radius: 10px; font-weight: 900; font-size: 1.2rem; }
        .alert { background: var(--red); color: white; padding: 10px; border-radius: 10px; display: none; font-weight: bold; margin-bottom: 1rem; }
        .stats { display: flex; justify-content: space-around; font-size: 0.9rem; color: #64748b; }
        .stats b { color: white; display: block; font-size: 1.1rem; }
        .broadcast-active .chart-card { display: none; }
        .broadcast-active .twod { font-size: 12rem; }
        button { background: var(--blue); border: none; padding: 10px 20px; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        #pat-val { color: var(--gold); }
    </style>
</head>
<body>
<div class="shell">
    <div id="elephant-alert" class="alert">üêò ELEPHANT LOCK DETECTED - DATA FROZEN</div>
    <div class="card">
        <button onclick="document.body.classList.toggle('broadcast-active')">TOGGLE BROADCAST MODE</button>
        <div style="margin-top:10px; font-size:0.7rem;">PAT THEE: <span id="pat-val">--</span></div>
    </div>
    <div class="card">
        <div class="label">LIVE SIGNAL</div>
        <div id="main-twod" class="twod">--</div>
        <div id="top-three" class="targets"></div>
    </div>
    <div class="card stats">
        <div>SET <b id="stat-set">--</b></div>
        <div>VALUE <b id="stat-value">--</b></div>
        <div>TIME <b id="stat-time">--</b></div>
    </div>
    <div class="card chart-card">
        <div class="label">MARKET VOLATILITY</div>
        <svg viewBox="0 0 600 100" style="width:100%; height:80px;"><polyline id="graph" points="" fill="none" stroke="#22ffcc" stroke-width="3" /></svg>
    </div>
</div>

<script>
    // 2. INITIALIZE SUPABASE CLIENT (Use your keys)
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; 
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = lib.createClient(SUPABASE_URL, SUPABASE_KEY);

    let lastSet = ""; let freezeCount = 0; let history = [];

    // --- A. THE REALTIME LISTENER (Runs only ONCE) ---
    supabase
      .channel('live-monitor')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'broadcast' }, (payload) => {
          console.log("Broadcast Received!", payload.new);
          const data = payload.new;
          // When the database updates, update the Top 3 and Pat Thee immediately
          const rows = data.rows.split(',');
          document.getElementById('top-three').innerHTML = rows.map(r => `<div class="target">${r.trim()}</div>`).join('');
          document.getElementById('pat-val').innerText = data.pat_thee || "N/A";
      })
      .subscribe();

    // --- B. THE MARKET UPDATER (Runs every 2 seconds) ---
    async function update() {
        try {
            const res = await fetch('/api/unified-live');
            const data = await res.json();
            const { live } = data;

            document.getElementById('main-twod').innerText = live.twod;
            document.getElementById('stat-set').innerText = live.set;
            document.getElementById('stat-value').innerText = live.value;
            document.getElementById('stat-time').innerText = live.time.split(' ')[1] || live.time;

            // Elephant Lock check
            if (live.set === lastSet && live.set !== "0" && live.set !== "--") freezeCount++; else freezeCount = 0;
            lastSet = live.set;
            document.getElementById('elephant-alert').style.display = freezeCount > 10 ? 'block' : 'none';

            // Volatility Graph
            const val = parseFloat(live.value.replace(/,/g, ''));
            if(!isNaN(val)) {
                history.push(val); if(history.length > 30) history.shift();
                const min = Math.min(...history), max = Math.max(...history), range = (max-min)||1;
                const pts = history.map((v, i) => `${(i/29)*600},${90-((v-min)/range)*80}`).join(' ');
                document.getElementById('graph').setAttribute('points', pts);
            }
        } catch (e) { console.error("Market Sync Error"); }
    }

    setInterval(update, 2000);
    update();
</script>
</body>
</html>